/*! form-storage - v1.0 - 2013-09-17 5:12:54 PM
* Copyright (c) 2013 舒克; Licensed  */
KISSY.add("gallery/form-storage/1.0/storage",function(a,b,c,d){a.Event;var e=b.extend({initializer:function(){var a,b=new c;if(a=b.getItem("formStorage"))try{a=d.parse(a)}catch(e){a={}}else a={};this.set("pagesSource",a),this.bindUI()},destructor:function(){},renderUI:function(){},bindUI:function(){this.on("afterPagesSourceChange",function(){var a=d.stringify(this.get("pagesSource")),b=new c;b.setItem("formStorage",a)},this)},save:function(b,c,d){var e=this.get("pagesSource");e[b]||(e[b]={}),e[b][c]=d,this.set("pagesSource",a.merge({},e))},load:function(a,b){var c=this.get("pagesSource");return c[a]?c[a][b]?c[a][b]:null:null}},{ATTRS:{pagesSource:{value:null}}});return new e},{requires:["rich-base","gallery/offline/1.1/index","json","node","event"]}),KISSY.add("gallery/form-storage/1.0/index",function(a,b,c,d,e){var f=window,g=f.location.pathname,h='<ul>{{#each data}}<li class="J_Item" data-index="{{xindex}}">{{#if remark}}<span class="label label-warning">{{/if}}{{remark}}{{#if remark}}</span>{{/if}}  {{title}} <a href="#" class="J_Restore">\u6062\u590d</a> <a href="#" class="J_EditRemark">\u5907\u6ce8</a> <a href="#" class="J_DelStorage">\u5220\u9664</a></li>{{/each}}</ul>',i=b.extend({initializer:function(){var a,b=this.get("node");if(b){var c=this.get("node").attr("id");c&&(this.set("autoSaveTimer",b.attr("data-auto-save-timer")||this.get("autoSaveTimer")),this.set("allowAutoSave","on"===b.attr("data-auto-save")?!0:!1),this.set("autoSaveMax",b.attr("data-auto-save-max")||this.get("autoSaveMax")),this.renderUI(),this.bindUI(),(a=e.load(g,c))&&this.set("source",a))}},renderUI:function(){var b=this.get("node");this.controlNode=a.one('<div class="form-storage"><p><span class="btn btn-default btn-xs">\u5df2\u542f\u7528\u672c\u5730\u4fdd\u5b58</span></p><div class="storage-list"><div class=" alert alert-success"><button type="button" class="btn btn-xs btn-success J_AddStorage">\u4e34\u65f6\u4fdd\u5b58</button><a href="https://github.com/Gourdboy/form-storage/blob/master/README.md" target="_blank">\u4ec0\u4e48\u662f\u4e34\u65f6\u4fdd\u5b58?</a><div class="J_History storage-list-content"></div></div></div></div>').insertBefore(b.prop("firstChild")),this.listNode=this.controlNode.one(".J_History")},bindUI:function(){var b=this.controlNode,c=this.get("node");b.delegate("click",".J_DelStorage",function(b){b.preventDefault();var c=a.one(b.currentTarget).parent(".J_Item").attr("data-index");this.del(c)},this),b.delegate("click",".J_Restore",function(b){b.preventDefault();var c=a.one(b.currentTarget).parent(".J_Item").attr("data-index");this.dataToForm(this.get("source")[c].data,this.get("node"))},this),b.delegate("click",".J_EditRemark",function(b){b.preventDefault();var c=a.one(b.currentTarget).parent(".J_Item").attr("data-index");this._edit(c)},this),this.on("afterSourceChange",this._syncHistoryUI,this);var d=this;if(c.delegate("click",".J_AddStorage",function(a){a.preventDefault(),this.save()},this),this.get("allowAutoSave")){var e=this.get("autoSaveTimer");setInterval(function(){var b=0,c=-1;a.each(d.get("source"),function(a,d){0==a.type&&(b++,c=d)}),b>d.get("autoSaveMax")&&d.del(c),d.save()},1e3*e)}},_getTime:function(a){function b(a){return a=a.toString(),a.length<2?0+a:a}return a=new Date(a),{year:b(a.getFullYear()),month:b(a.getMonth()+1),date:b(a.getDate()),hour:b(a.getHours()),minute:b(a.getMinutes()),second:b(a.getSeconds())}},formToData:function(b){var d=[],e=c.serialize(b);return a.log(e),a.each(e.split("&"),function(a){a=a.split("="),d.push(a)}),d},dataToForm:function(b,c){return c[0].reset(),c.all('input[type="radio"],input[type="checkbox"]').each(function(a){a.prop("checked",!1)}),a.each(b,function(a){a[1]=decodeURIComponent(a[1]);var b=c.one(":input[name="+a[0]+"]");if(b&&!("off"===b.attr("data-storage")||b.hasAttr("type")&&"hidden"===b.attr("type").toLowerCase())){var d=b.attr("type")&&b.attr("type").toLowerCase();if("radio"===d||"checkbox"===d){var e=c.one(":input[name="+a[0]+"][value="+a[1]+"]");e&&e.prop("checked",!0)}else b.val(a[1]);this.fire("restoreitem",{node:b})}},this),this.fire("restore",{source:this.get("source"),srcForm:this.get("node").attr("id")}),this},save:function(a){var b=this.formToData(this.get("node")),c=new Date;if(b){a=a||{type:1,remark:"",time:c,data:b};var d=this.get("source");return this.get("form"),d=d.concat(),d.unshift(a),this.set("source",d),this}},del:function(a){var b=this.get("source");return this.get("form"),b=b.concat(),b.splice(a,1),this.set("source",b),this},_edit:function(b){var c=prompt("\u8bf7\u8f93\u5165\u5907\u6ce8\u540d\u79f0:");if(""!=a.trim(c)){var d=this.get("source").concat();d[b].remark=c,d[b].type=1,this.set("source",d)}},_syncHistoryUI:function(){var b=this.get("source");b.sort(function(a,b){return b.type-a.type}),b=a.map(b,function(b){if(!b)return null;var c=1===b.type?"\u624b\u52a8":"\u81ea\u52a8";return b.title=a.substitute(c+"\u4fdd\u5b58\u4e8e {year}-{month}-{date} {hour}:{minute}:{second}",this._getTime(b.time)),b},this),this.listNode.html(new d(h).render({data:b})),e.save(g,this.get("node").attr("id"),b)},destructor:function(){}},{ATTRS:{node:{value:null,setter:function(b){return a.one(b)}},source:{value:[]},allowAutoSave:{value:!1},autoSaveTimer:{value:300},autoSaveMax:{value:5}},bind:function(b){b=a.merge({selector:"form",callback:null}),a.all(b.selector).each(function(c,d){if("on"===c.attr("data-save")){var e=c.attr("id");e||(e="J_StorageId"+d,c.attr("id",e));var f=new Form({node:c});a.isFunction(b.callback)&&b.callback.call(this,f,e)}},this)}});return i},{requires:["rich-base","ajax","xtemplate","./storage","node","event","sizzle"]});